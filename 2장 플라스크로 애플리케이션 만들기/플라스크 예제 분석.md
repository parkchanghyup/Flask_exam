# 플라스크 예제 분석

```python
manage.py

# -*- coding: utf-8 -*-
import os
import sys
# 현재 경로를 시세틈에 넣어주는 코드.
sys.path.append(os.path.dirname(os.path.abspath(__file__)))
from config import Config

# 윈도우와 맥,리눅스의 파일경로가 다르기 때문에 예외 처리하는 코드
try:
    activate_this = '{0}/venv/bin/activate_this.py'.format(Config.ROOT_DIR)
    with open(activate_this) as f:
        exec(f.read(), dict(__file__=activate_this))
except FileNotFoundError:
    activate_this = '{0}/venv/Scripts/activate_this.py'.format(Config.ROOT_DIR)
    with open(activate_this) as f:
        exec(f.read(), dict(__file__=activate_this))

# wsgi를 사용하려면 반드시 app을 임포트 해서  application 으로 변환해 줘야 함
from apps.controllers.router import app as application

# test, runserver, db 등의 커맨드를 사용할 수 있는 객체
from apps.common.commands.manager import manager

if __name__ == '__main__':
    manager.run()

```

```python
# -*- coding: utf-8 -*-
import os
import json


ROOT_DIR = os.path.dirname(os.path.abspath(__file__))
DATA = json.loads(open('{}/config.json'.format(ROOT_DIR)).read())


class JsonConfig:
    """
    config.json 파일에서 값을 가져오는 역할을 함.
    """
    @staticmethod
    def get_data(varname, value=None):
        return DATA.get(varname) or os.environ.get(varname) or value

    @staticmethod
    def set_data(key, value):
        DATA[key] = value
        with open('{}/config.json'.format(ROOT_DIR), 'w') as f:
            json.dump(DATA, f, indent=4)


# app config
class Config:

    ROOT_DIR = ROOT_DIR
    STATIC_DIR = '{0}/static'.format(ROOT_DIR)
    TEMPLATES_DIR = '{0}/templates'.format(ROOT_DIR)
    ERROR_CODE = {
        40000: 'Bad Request',
        41000: 'Gone',
        40300: 'Forbidden',
        40400: 'Not Found',
        50000: 'Internal Server Error',
    }

    APP_MODE_PRODUCTION = 'production'
    APP_MODE_DEVELOPMENT = 'development'
    APP_MODE_TESTING = 'testing'

    APP_MODE = JsonConfig.get_data('APP_MODE', APP_MODE_PRODUCTION)
    APP_HOST = JsonConfig.get_data('APP_HOST', '0.0.0.0')
    APP_PORT = int(JsonConfig.get_data('APP_PORT', 80))

    # DB정보를 정의할 때도 JsonConfig클래스를 사용
    DB_USER_NAME = JsonConfig.get_data('DB_USER_NAME', 'root')
    DB_USER_PASSWD = JsonConfig.get_data('DB_USER_PASSWD', 'password')
    DB_HOST = JsonConfig.get_data('DB_HOST', 'localhost')
    DB_NAME = JsonConfig.get_data('DB_NAME', 'flask')

    REDIS_HOST = JsonConfig.get_data('REDIS_HOST', 'localhost')
    REDIS_PASSWD = JsonConfig.get_data('REDIS_PASSWD')

    @staticmethod
    def from_app_mode():
        mode = {
            Config.APP_MODE_PRODUCTION: 'config.ProductionConfig',
            Config.APP_MODE_DEVELOPMENT: 'config.DevelopmentConfig',
            Config.APP_MODE_TESTING: 'config.TestingConfig',
        }
        return mode.get(Config.APP_MODE, mode[Config.APP_MODE_DEVELOPMENT])

    @staticmethod
    def database_url(dialect='mysql'):
        if dialect == 'mongodb':
            return '{}://{}:{}@{}'.format(dialect, Config.DB_USER_NAME, Config.DB_USER_PASSWD, Config.DB_HOST)

        return '{}://{}:{}@{}/{}?charset=utf8'.format(dialect, Config.DB_USER_NAME, Config.DB_USER_PASSWD,
                                                      Config.DB_HOST, Config.DB_NAME)


# flask config
class FlaskConfig:
    SECRET_KEY = '9022b99ae34ae74ec06bbeac8653b6c98a6ff9ee66ac4f96'
    SQLALCHEMY_DATABASE_URI = Config.database_url()
    # https://stackoverflow.com/questions/33738467/how-do-i-know-if-i-can-disable-sqlalchemy-track-modifications
    SQLALCHEMY_TRACK_MODIFICATIONS = False
    DEBUG = False
    TESTING = False


class ProductionConfig(FlaskConfig):
    pass


class DevelopmentConfig(FlaskConfig):
    SQLALCHEMY_ECHO = True
    DEBUG = True
    TESTING = True


class TestingConfig(FlaskConfig):
    TESTING = True

```
JsonConfig 클래스는 config.json 파일에서 값을 가져오는 역할을 한다.  
```python
class JsonConfig:
```
DB 정보들을 정의할 때도 JsonConfig클래스를 사용한다. 

```python
DB_USER_NAME = JsonConfig.get_data('DB_USER_NAME', 'root')
DB_USER_PASSWD = JsonConfig.get_data('DB_USER_PASSWD', 'password')
DB_HOST = JsonConfig.get_data('DB_HOST', 'localhost')
DB_NAME = JsonConfig.get_data('DB_NAME', 'flask')
```
Config 클래스는 `database_url()`과 `from_app_mode()`함수를 중점으로 보면된다.  
```python
class Config:
```
`database_url()`은 앞에서 정의한 DB 정보를 가지고 `DATABASE_URL`(DB에 접속하는 주소)을 생성한다.
`from_app_mode()` 함수는 정의해 놓은 환경값에 따라 플라스크에서 환경값으로 쓰이는 클래스가 달라진다.
production, development, testing 세 가지 중 development 값이 기본값이다.
**주의할 점은 FlaskConfig의 SECRET_KEY는 값을 다르게 주어야 세션값이 노출 되지 않는다.**  


다음으로 apps폴더를 살펴보자. apps폴더에는 다음과 같은 폴더들이 있다.  
|폴더명|설명|
|---|------|
|common|공통 로직 및커맨드 조작, 블루프린트 자동 등록 클래스가 있다.|
|controllers|블루프린트 기반 컨트롤러들이 있다.|
|database|DB 연결 클래스 및 모델들이 있다.|
|test|컨트롤러 및 DB 테스트 코드가 있다.|

common부터 살펴보자.  
모든 컨트롤러는 블루프린트로 관리되는데, 블루프린트를 사용하는 컨트롤러가 많을수록 등록해야 하는 블루프린트 개수도 늘어난다.  
그래서 자동으로 임포트해주는 코드가 `register.py`에 정의되어 있다.
```python
register.py
# -*- coding: utf-8 -*-
import importlib
import os
import re


class BlueprintRegister(object):
    '''
    컨트롤러 경로를 추적해 블루프린트를 등록
    '''
    def __init__(self, app, module_path, controller_name):
        self.app = app
        self.module_path = module_path
        self.controller_name = controller_name
        self.controller_path = self.app.root_path
        self.directories = []

    def register(self):
        '''
        이 함수에서 블루프린트를 등록.
        '''
        self.find_dir(self.controller_path)
        for dir_path in self.directories:
            dir_path = dir_path[1:].replace('/', '.')
            module_path = '{}.{}.{}'.format(self.module_path, dir_path, self.controller_name)
            module = importlib.import_module(module_path)
            self.app.register_blueprint(module.app)

    def find_dir(self, path):
        files = os.listdir(path)
        for file_name in files:
            isdir = os.path.isdir('{}/{}'.format(path, file_name))
            if not isdir:
                continue
            ignore = self.ignore(file_name)
            if ignore:
                continue
            self.append_dir(path, file_name)

    def append_dir(self, path, file_name):
        dir_path = '{}/{}'.format(path, file_name)
        self.directories.append(dir_path.replace(self.controller_path, ''))
        self.find_dir(dir_path)

    def ignore(self, name):
        # __pycache__/
        if re.match('__.*__', name):
            return True
        return False
```
register() 함수를 보면 컨트롤러 경로를 추적해 블루프린트를 등록하는 것을 알 수 있다.  
```python
module = importlib.import_module(module_path)
self.app.register_blueprint(module.app)
```
원래대로라면 컨트롤러마다 등록해야 했지만 BlueprintRegister 클래스로 해결한 것을 알 수 있다.
```python
# -*- coding: utf-8 -*-
from flask import Flask

from apps.common.register import BlueprintRegister
from apps.common.response import error

from config import Config

app = Flask(__name__, template_folder=Config.TEMPLATES_DIR, static_folder=Config.STATIC_DIR)
app.config.from_object(Config.from_app_mode())
# 컨트롤러마다 등록해야 되지만 BlueprintRegister클래스로 해결
BlueprintRegister(app=app, module_path='apps.controllers', controller_name='controllers').register()


@app.errorhandler(403)
def forbidden(err):
    return error(40300)


@app.errorhandler(404)
def page_not_found(err):
    return error(40400)


@app.errorhandler(410)
def gone(err):
    return error(41000)


@app.errorhandler(500)
def internal_server_error(err):
    return error(50000)

```

이번에는 데이터베이스를 살펴보자.   
데이터베이스는 `model.py`와 `session.py`가 있고, models.py는 데이터베이스 테이블이 있는 파일로 `session.py`에서 정의한 db를 가지고 테이블을 정의한다. 
```python
# -*- coding: utf-8 -*-
from redis import Redis
from flask_sqlalchemy import SQLAlchemy

from config import Config
from apps.controllers.router import app

db = SQLAlchemy(app)
cache = Redis(host=Config.REDIS_HOST, password=Config.REDIS_PASSWD)


@app.teardown_request
def shutdown_session(exception=None):
    db.session.remove()

```
app을 가져와 db를 정의한다.
```python
db = SQLAlchemy(app)
```
이렇게 정의한 db는 테이블을 정의하는데 사용한다.
여기서 특이한 점은 **models.py에서는 같은 테이블을 두 번 만드는데**, tests라는 테이블을 test를 붙여 test_tests라는 테이블을 만든다.
이유는 테스트할 때 테스트 테이블을 사용하여 실제 테이블과 섞이지 않게 하려는 것이다.
```python
from apps.database.session import db
from config import JsonConfi

def get_model(model):
    if JsonConfig.get_data('TESTING'):
        return model.test_model
    return model


class TestMixin:
    id = db.Column(db.Integer, primary_key=True, autoincrement=True)
    message = db.Column(db.String(120))


class TestTestModel(TestMixin, db.Model):
    __tablename__ = 'test_tests'


class TestModel(TestMixin, db.Model):
    __tablename__ = 'tests'

    test_model = TestTestModel


Test = get_model(TestModel)
```
