# 플라스크 확장
## Flask-SQLAIchemy
`Flask-SQLAIchemy`는 `SQLAIchemy에 대해 지원을 추가하는 플라스크 확장 모듈이다.    
SQLAIchemy의 일반적인 작업을 더 쉽게 수행할 수 있도록 유용한 기능들을 제공한다.  

`app.config.from_object()` 함수로 플라스크 환경을 설정한다. 이때 `Config.from_app_mode`를 추적하면 DB URI설정을 볼 수 있다.  
```python
apps/controllers/router.py
from flask import Flask

from apps.common.register import BlueprintRegister
from apps.common.response import error

from config import Config

app = Flask(__name__, template_folder=Config.TEMPLATES_DIR, static_folder=Config.STATIC_DIR)
app.config.from_object(Config.from_app_mode())
```
`FlaskConfig`는 공통으로 상속받는 클래스로 플라스크 설정에 필요한 기본값들이 들어있다.  

```python
config.py
class FlaskConfig:
    SQLALCHEMY_DATABASE_URI = Config.database_url()
```
플라스크 설정을 끝냈다면 DB를 지정하면 되는데, SQLAIchemy 클래스를 가져와 정의한다. 그리고 apps/controllers/test/controllers.py를 수정한다.   
RESTful api를 설계해보면서 ORM에 대해 이해해보자.  

> `ORM(Object-relational mapping)`은 데이터베이스와 객체 지향 프로그래밍 언어 간의 호환되지 않는 데이터를 변환하는 프로그래밍 기법이다.  
객체 지향 언어에서 사용할 수 있는 `가상`객체 데이터베이스를 구축하는 방법이다.

아래표는 만들어야 할 API리스트이다.
|메서드|URL|설명|
|---|---|---|
|GET|/test|tests 테이블에 있는 모든 데이터를 가져온다.|
|POST|/test|tests 테이블에 데이터를 추가한다.|
|DELETE|/test/test_id|tests 테이블에 test_id를 가진 데이터를 삭제한다.|
|PUT|/test/test_id|tests 테이블에 test_id를 가진 데이터를 수정한다.|

```python
# -*- coding: utf-8 -*-
import requests
from flask import Blueprint, abort, render_template, request

from apps.common.response import ok, error
from apps.database.models import Test
from apps.database.session import db
from .forms import TestForm

app = Blueprint('test', __name__, url_prefix='/test')


@app.route('', methods=['GET'])
def get_tests():
    tests = Test.query.all()
    return render_template('test/test.html', tests=tests)


@app.route('', methods=['POST'])
def create_test():
    test = Test(message='Hello World!!!')
    db.session.add(test)
    db.session.commit()
    return ok()


@app.route('/<int:test_id>', methods=['DELETE'])
def delete_test(test_id):
    test = Test.query.filter(Test.id == test_id).first()
    db.session.delete(test)
    db.session.commit()
    return ok()


@app.route('/<int:test_id>', methods=['PUT'])
def update_test(test_id):
    test = Test.query.filter(Test.id == test_id).first()
    test.message = 'Hello World2!!!'
    db.session.commit()
    return ok()
```

```python
@app.route('', methods=['GET'])
def get_tests():
    tests = Test.query.all()
    return render_template('test/test.html', tests=tests)
```
tests 테이블의 모든 데이터를 조회한다. Jinja2 문법에서 클래스를 받을 수 있어 tests 변수에 담아 넘겨줬다. 데이터가 잘 나오는지는 모든 API를 작성한 뒤 테스트할 때 확인해보자
```python
tests = Test.query.all()
```
Test 모델에 인자를 넣어주는 방식으로 데이터를 저장한다. 데이터를 저장한 뒤 db.session.add() 함수로 값을 세션에 넣어준다. 마지막으로 db.session.commit을 함으로써 데이터 저장을 확정한다.

```python
@app.route('', methods=['POST'])
def create_test():
    test = Test(message='Hello World!!!')
    db.session.add(test)
    db.session.commit()
    return ok()
```
삭제 API도 db.session.add에서 db.session.delete로 바뀌었을 뿐 큰 차이점은 없다.

```python
@app.route('/<int:test_id>', methods['DELETE'])
def delete_test(test_id):
    test = Test.query.filter(Test.id == test_id).first()
    db.session.delete(test)
    db.session.commit()
    return ok()
```
test.attribute로 데이터에 접근한다. 그리고 커밋을 통해 데이터 수정을 확정 한다.

```python
@app.route('/<int:test_id>', methods=['PUT'])
def update_test(test_id):
    test = Test.query.filter(Test.id == test_id).first()
    test.message = 'Hello World2!!!'
    db.session.commit()
    return ok()
```

**ORM으로 배우는  SQL쿼리문**
```sql
# equals
Test.query.filter(Test.id == 1)

# not equals
Test.query.filter(Test.id != 1)

# LIKE
Test.query.filter(Test.message.like('%hello%'))

# IN
Test.query.filter(Test.id.in_[1, 2, 3])

# IS NULL
Test.query.filter(Test.id == None)

# IS NOT NULL
Test.query.filter(Test.id != None)

# AND
Test.query.filter(Test.id == 1, Test.message != None)
Test.query.filter(and_(Test.id == 1, Test.message != None))
Test.query.filter(Test.id == 1).filter(Test.message != None)

# OR
Test.query.filter(and_(Test.id == 1, Test.message != None))
```

## Flask-Script

Flask-Script는 Flask itself와 유사하게 작동한다. 데코레이터로 명령을 정의하고 Manager 인스턴스에 다음 명령어를 추가한다. 
아래 코드는 스크립트를 활용해서 명령어를 만들어보는 코드이다. 

```python
# -*- coding: utf-8 -*-
import unittest2
from flask_script import Manager
from flask_migrate import Migrate, MigrateCommand


from apps.controllers.router import app
from apps.database.session import db
from config import Config, JsonConfig

migrate = Migrate(app, db)
manager = Manager(app)
manager.add_command('db', MigrateCommand)


@manager.command
def test():
    """test code"""
    loader = unittest2.TestLoader()
    start_dir = '{0}/apps'.format(Config.ROOT_DIR)
    suite = loader.discover(start_dir)

    runner = unittest2.TextTestRunner()
    r = runner.run(suite)

    if r.wasSuccessful():
        print('success')
    else:
        print('fail')
        exit(1)


@manager.option('-h', '--host', dest='host', default=Config.APP_HOST)
@manager.option('-p', '--port', dest='port', default=Config.APP_PORT)
def runserver(host, port):
    """run flask server"""
    app.run(host=host, port=int(port))
```
먼저 Manager 객체를 선언한다.
```python
manager = Manager(app)
```
그 뒤에 데코레이터를 선언해 명령할 코드를 정의한다. 이때 함수 이름이 곧 명령어가 된다.  
`python manage.py test`로 해당 함수를 호출한다 
```python
@manager.command
def test()
```
이번에는 runserver를 정의해보자. 역시 `python manage.py runserver`로 호출 할 수 있다. 

```python
@manager.option('-h', '--host', dest='host', default=Config.APP_HOST)
@manager.option('-h', '--post', dest='host', default=Config.APP_PORT)
```

다음 코드는 manage.py에서 해당 명령어들을 사용할 수 있게 선언하는 코드이다.  
```python
manage.py
from apps.common.commands.manager import manager

if __name__ =='__main__':
    manager.run()
```
**플라스크 스크립트는 db, cron 등의 명령어를 연결해 다양하게 활용할 수 있는 유용한 모듈이다.**

## Flask-WTF
플라스크용 WTForms는 CSRF,file upload등을 지원한다.  

아래 코드는 플라스크 폼 검사 패키지를 활용한 폼 검사에 관한 예제 코드이다.

```python
# -*- coding: utf-8 -*-
from flask_wtf import FlaskForm
from wtforms import StringField, SelectField, IntegerField
from wtforms.validators import DataRequired, NumberRange, Length


class TestForm(FlaskForm):
    fruits = SelectField('fruits', validators=[DataRequired()], choices=[])
    username = StringField('username', validators=[DataRequired(), Length(max=10, message='10자를 넘을 수 없습니다.')])
    amount = IntegerField('amount', validators=[DataRequired(),
                                                NumberRange(min=1, max=10000, message='자릿수를 초과했습니다.')])

```

```python
apps/controllers/test/controllers.py
# -*- coding: utf-8 -*-
...

from .forms import TestForm

...

@app.route('/html', methods=['GET', 'POST'])
def html():
    form = TestForm()

    fruits = {'apple': '사과', 'orange': '오렌지', 'grape': '포도'}
    for key in fruits.keys():
        form.fruits.choices.append((key, fruits[key]))

    if form.validate_on_submit():
        return render_template('test/html.html', form=form, result='저장했습니다.')

    return render_template('test/html.html', form=form)
```
```html
{% extends 'layout/base.html' %}

{% block head %}
  <title>test</title>
{% endblock %}

{% block body %}
  <div class="row">
    <div class="col-lg-3 m-2">
      <form action="/test/html" method="post">
        {{ form.hidden_tag() }}
        <div class="form-group row">
          <label class="col-form-label col-lg-3">과일들</label>
          <div class="col-lg-9">
            {{ form.fruits(class='form-control') }}
            <div class="invalid-feedback d-block">
              {{ form.fruits.errors[0] }}
            </div>
          </div>
        </div>
        <div class="form-group row">
          <label class="col-form-label col-lg-3">가격</label>
          <div class="col-lg-9">
            {{ form.amount(class='form-control') }}
            <div class="invalid-feedback d-block">
              {{ form.amount.errors[0] }}
            </div>
          </div>
        </div>
        <div class="form-group row">
          <label class="col-form-label col-lg-3">구매자</label>
          <div class="col-lg-9">
            {{ form.username(class='form-control') }}
            <div class="invalid-feedback d-block">
              {{ form.username.errors[0] }}
            </div>
          </div>
        </div>
        <div class="form-group">
          <span class="text-primary">{{ result }}</span>
        </div>
        <div class="form-group">
          <button class="btn btn-primary float-right" type="submit" value="submit">저장</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

```
먼저 Form부터 살펴보면 Form은 FlaskForm 객체를 상속받는다.
```python
class TestForm(FlaskForm):
    fruits = SelectField('fruits', validators=[DataRequired()], choices=[])
    username = StringField('username', validators=[DataRequired(), Length(max=10, message='10자를 넘을 수 없습니다.')])
    amount = IntegerField('amount', validators=[DataRequired(),
                                                NumberRange(min=1, max=10000, message='자릿수를 초과했습니다.')])

```
변수평 = 필드타입(라벨명, 검증 함수들, 그 외 옵션들) 기본틀 이고, 여기서는 과일들을 여러 개 선택하고 싶어서 SelectFidel를 선택 했고 validattors로는 DataRequired를 넣었다. 데이터가 없다면 에러를 출력한다.  
```python
fruits = SelectField('fruits', validators = [DataRequired()], choices = [])
```
이번에는 StringField이다. 다른 점은 Length가 들어갔다. 데이터의 존재 여부도 중요하지만 있을 때의 조건도 중요하다. 10글자로 제한을 주었고, 조건에 만족하지 않을 때는 메시지를 출력하게 했다.  

```python
username = StringField('username', validators = [DataRequired(), Length(max = 10, message = '10자를 넘을 수 없습니다.')])
```

이번에는 컨트롤러 로직에 폼 검사를 어떻게 활용하는지에 관한 예제 코드이다.  

```python
form  = TestForm()

fruits = {'apple': '사과', 'orange' : '오렌지', 'grape' : '포도'}
for key in fruits.keys():
    form.fruits.choices.append((key, fruits[key]))

if form.validate_on_submit():
    return render_template('test/html.html', form=form, result = '저장했습니다.')
return render_template('test/html.html', form=form)
```
SelectField를 위해서 값을 넣어줬다. 아까 choices 변수에 값이 들어간다고 보며 된다.

```python
fruits = {'apple': '사과', 'orange' : '오렌지', 'grape' : '포도'}
for key in fruits.keys():
    form.fruits.choices.append((key, fruits[key]))
```
form.validate_on_submit는 폼 값이 조건에 만족할 경우 True를 리턴한다. result 변수에 정상적으로 저장되었다고 알리는 값을 추가했다.
```python
if form.validate_on_submit():
    return render_template('test/html.html', form=form, result = '저장했습니다.')

```
html에서는 아까 라벨에 설정한 값을 가지고 접근한다. 에러를 보고 싶을 때는 form.라벨.errors를 출력한다. 

```html
  <div class="col-lg-9">
    {{ form.fruits(class='form-control') }}
    <div class="invalid-feedback d-block">
      {{ form.fruits.errors[0] }}
    </div>
  </div>
```